---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

export const prerender = false;

interface Props {
  title: string;
  description?: string;
  activeSection?: string;
}

const { title, description, activeSection } = Astro.props;
const currentLocale = Astro.currentLocale || "fr";
const t = await import(`../i18n/${currentLocale}.json`);

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect(getRelativeLocaleUrl(currentLocale, currentLocale === "fr" ? "/auth/connexion" : "/auth/sign-in"));
}

interface SidebarItem {
  key: string;
  label: string;
  href: string;
  icon: string;
  roles?: string[];
}

const sidebarItems: SidebarItem[] = [
  { key: "profile", label: t.dashboard.profile, href: getRelativeLocaleUrl(currentLocale, currentLocale === "fr" ? "/profil" : "/profile"), icon: "mdi:account" },
  { key: "places", label: t.dashboard.myPlaces, href: getRelativeLocaleUrl(currentLocale, "/dashboard/places"), icon: "mdi:map-marker" },
  { key: "articles", label: t.dashboard.myArticles, href: getRelativeLocaleUrl(currentLocale, "/dashboard/articles"), icon: "mdi:newspaper" },
  { key: "ads", label: t.dashboard.myAds, href: getRelativeLocaleUrl(currentLocale, "/dashboard/classifieds"), icon: "mdi:tag" },
  { key: "services", label: t.dashboard.myServices, href: getRelativeLocaleUrl(currentLocale, "/dashboard/services"), icon: "mdi:briefcase" },
  { key: "bookings", label: t.dashboard.myBookings, href: getRelativeLocaleUrl(currentLocale, "/dashboard/bookings"), icon: "mdi:calendar-check" },
  { key: "favorites", label: t.dashboard.favorites, href: getRelativeLocaleUrl(currentLocale, "/dashboard/favorites"), icon: "mdi:heart" },
  { key: "messages", label: t.dashboard.messages, href: getRelativeLocaleUrl(currentLocale, "/dashboard/messages"), icon: "mdi:message" },
  { key: "notifications", label: t.dashboard.notifications, href: getRelativeLocaleUrl(currentLocale, "/dashboard/notifications"), icon: "mdi:bell" },
  { key: "wallet", label: t.dashboard.wallet, href: getRelativeLocaleUrl(currentLocale, "/dashboard/wallet"), icon: "mdi:wallet" },
  { key: "mediation", label: t.dashboard.mediation, href: getRelativeLocaleUrl(currentLocale, "/dashboard/mediation"), icon: "mdi:scale-balance" },
];
---

<BaseLayout title={title} description={description}>
  <div class="dashboard-layout">
    <nav class="dashboard-sidebar" aria-label={t.dashboard.title}>
      <h2 class="dashboard-sidebar-title">{t.dashboard.title}</h2>
      <ul class="dashboard-nav" role="list">
        {sidebarItems.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={["dashboard-nav-link", { active: activeSection === item.key }]}
              aria-current={activeSection === item.key ? "page" : undefined}
            >
              <span class="dashboard-nav-label">{item.label}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>
    <main class="dashboard-content">
      <slot />
    </main>
  </div>
</BaseLayout>

<style>
  .dashboard-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: calc(100vh - 80px);
    gap: 0;
  }

  .dashboard-sidebar {
    background: var(--bg-secondary, #f8f9fa);
    border-right: 1px solid var(--border-color, #e2e8f0);
    padding: var(--space-4, 1rem) 0;
    position: sticky;
    top: 80px;
    height: calc(100vh - 80px);
    overflow-y: auto;
  }

  .dashboard-sidebar-title {
    font-size: var(--text-lg, 1.125rem);
    font-weight: 700;
    padding: 0 var(--space-4, 1rem) var(--space-3, 0.75rem);
    border-bottom: 1px solid var(--border-color, #e2e8f0);
    margin: 0 0 var(--space-2, 0.5rem) 0;
  }

  .dashboard-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .dashboard-nav-link {
    display: flex;
    align-items: center;
    gap: var(--space-2, 0.5rem);
    padding: var(--space-2, 0.5rem) var(--space-4, 1rem);
    text-decoration: none;
    color: var(--text-secondary, #64748b);
    font-size: var(--text-sm, 0.875rem);
    transition: background-color 0.15s, color 0.15s;
    border-left: 3px solid transparent;
  }

  .dashboard-nav-link:hover {
    background: var(--bg-hover, #f1f5f9);
    color: var(--text-primary, #1e293b);
  }

  .dashboard-nav-link.active {
    background: var(--bg-active, #eff6ff);
    color: var(--color-primary, #3b82f6);
    border-left-color: var(--color-primary, #3b82f6);
    font-weight: 600;
  }

  .dashboard-content {
    padding: var(--space-6, 1.5rem) var(--space-8, 2rem);
    max-width: 1200px;
  }

  @media (max-width: 768px) {
    .dashboard-layout {
      grid-template-columns: 1fr;
    }

    .dashboard-sidebar {
      position: static;
      height: auto;
      border-right: none;
      border-bottom: 1px solid var(--border-color, #e2e8f0);
    }

    .dashboard-nav {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1, 0.25rem);
      padding: var(--space-2, 0.5rem);
    }

    .dashboard-nav-link {
      border-left: none;
      border-radius: var(--radius-md, 0.375rem);
      padding: var(--space-1, 0.25rem) var(--space-3, 0.75rem);
    }

    .dashboard-nav-link.active {
      border-left-color: transparent;
    }
  }
</style>
