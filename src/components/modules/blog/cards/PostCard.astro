---
import Grid from "@components/Tools/Grid.astro";
import Flex from "@components/Tools/Flex.astro";
import Link from "@components/ui/Link.astro";
import Button from "@components/ui/Button.astro";
import Card from "@components/ui/Card/Card.astro";
import CardContent from "@components/ui/Card/CardContent.astro";
import CardHeader from "@components/ui/Card/CardHeader.astro";
import CardFooter from "@components/ui/Card/CardFooter.astro";

import CategoryBadge from "@components/modules/blog/ui/CategoryBadge.astro";
import PostMeta from "@components/modules/blog/ui/PostMeta.astro";
import StarRating from "@components/modules/blog/ui/StarRating.astro";
import ImageWithFallback from "@components/modules/blog/ui/ImageWithFallback.astro";

import { actions } from "astro:actions";

interface Props {
  post: any;
  lang: string;
  rating?: number;
  count?: number;
  href?: string;
  variant?: 'initial' | 'retro' | 'modern' | 'futuristic';
}

const { post, lang, rating, count, href: propHref, variant = 'initial' } = Astro.props;

// --- LOGIQUE R√âELLE ---
const displayRating = rating || 0;
const displayCount = count || 0;

// Null-safe categories (pr√©venir les erreurs si la collection manque la cl√©)
const cats = post.data.categories ?? [];
const primaryCat = cats[0]?.slug;
// Prefer explicit prop `href` when provided (index.astro passes `/${lang}/blog/${post.data.slug}`).
// Otherwise build category-aware URL when possible, or fallback to category-less post URL.
const link = propHref ?? (primaryCat ? `/${lang}/blog/${primaryCat}/${post.data.slug}` : `/${lang}/blog/${post.data.slug}`);
---

<Card
  class={`post-card ${variant}`}
  role="article"
  aria-labelledby={`post-title-${post.data.slug}`}
>
  <Link href={link} className="post-image-link" ariaLabel={`Article: ${post.data.title}`}>
    <ImageWithFallback
      src={post.data.cover?.url}
      text={post.data.title}
      alt={post.data.cover?.alt}
      class="post-image"
    />
  </Link>

  <CardHeader class="post-header">
    <div class="post-header-top">
      <Flex alignItems="center" justifyContent="space-between" marginBottom="md">
          {
            cats
              .slice(0, 1)
              .map((cat: any) => (
                <CategoryBadge name={cat.name} slug={cat.slug} lang={lang} />
              ))
          }
        {post.data.publishedAt && (
          <time class="post-date" datetime={post.data.publishedAt.toISOString()}>
            {post.data.publishedAt.toLocaleDateString(lang, { day: 'numeric', month: 'short' })}
          </time>
        )}
      </Flex>

      <StarRating rating={displayRating} count={displayCount} size="sm" variant={variant} color="primary" />
    </div>

    <div class="post-title-row">
      <Link href={link} className="post-title-link" ariaLabel={post.data.title}>
        <h3 id={`post-title-${post.data.slug}`} class="post-title">
          {post.data.title}
        </h3>
      </Link>
    </div> 
  </CardHeader>

  <CardContent class="post-content">
    <p class="post-excerpt">
      {post.data.excerpt}
    </p>
  </CardContent>

  <CardFooter className="post-footer">
    <PostMeta
      publishedAt={post.data.publishedAt}
      readingTime={post.data.readingTime}
      authors={post.data.authors}
      lang={lang}
      className="post-meta"
    />
    {
        (Astro.locals.user?.role === "admin" ||
          Astro.locals.user?.id === post.ownerId) && (
      <Flex 
        alignItems="center" 
        justifyContent="flex-end"
        class="post-edit">
            <Link 
              href={`/${lang}/admin/posts/${post.id}`}
              aria-label={`√âditer ${post.data.title}`}
              style="button"
              color="secondary"
              icon={{ name: "mdi:edit", side: "left" }}
            />
            <form
              method="POST"
              action={actions.blog.changeStatus}
              class="post-status-form"
            >
              <input type="hidden" name="id" value={post.id} />
              <Button
                type="submit"
                name="status"
                value="published"
                title="Publier"
                aria-label={`Publier ${post.data.title}`}
                class="post-status-button"
                disabled={post.status === "published"}
              >
                üìù
              </Button>
            </form>
          </Flex>
        )
      }
  </CardFooter>
</Card>

<style scoped>
.card { max-width: 400px; }

.post-image-link { display:block; width:100%; height: 220px; overflow:hidden; border-radius: var(--card-border-radius); }
.post-date { margin-left: var(--space-2); font-size: 0.875rem; color: var(--text-muted-foreground); }
.post-image { width:100%; height:100%; object-fit: cover; display:block; transition: transform 220ms ease; }
.post-image-link:hover .post-image { transform: scale(1.03); }
.post-title-row { margin-top: var(--space-3); }
.post-title { margin: 0; font-size: 1.125rem; font-weight: 700; color: var(--text-foreground); }
.post-excerpt { color: var(--text-muted-foreground); margin: 0; }
.post-title-link { text-decoration: none; display: inline-block; width:100%; }
.post-title-link:hover .post-title { text-decoration: underline; }
.post-edit { background-color: red; margin-top:40px; }
</style>