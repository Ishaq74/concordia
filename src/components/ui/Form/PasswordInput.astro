---
interface Props {
  id: string;
  name?: string;
  value?: string;
  placeholder?: string;
  required?: boolean;
  disabled?: boolean;
  readonly?: boolean;
  autocomplete?: string;
  variant?: "initial" | "retro" | "modern" | "futuristic";
  error?: string;
  showPasswordToggle?: boolean;
  className?: string;
}

const {
  id,
  name,
  value,
  placeholder = "••••••••",
  required = false,
  disabled = false,
  readonly = false,
  autocomplete = "current-password",
  variant = "initial",
  error,
  showPasswordToggle = true,
  className = "",
} = Astro.props;

const variantClass = variant !== "initial" ? variant : "";
const inputClasses = [
  "input-with-icon-right",
  error && "input-error",
  variantClass,
  className,
]
  .filter(Boolean)
  .join(" ");
---

<div class="input-wrapper has-icon password-input-wrapper">
  <input
    type="password"
    id={id}
    name={name || id}
    value={value}
    placeholder={placeholder}
    required={required}
    disabled={disabled}
    readonly={readonly}
    autocomplete={autocomplete}
    aria-invalid={error ? "true" : undefined}
    aria-describedby={error ? `${id}-error` : undefined}
    class={inputClasses}
  />

  {
    showPasswordToggle && (
      <button
        type="button"
        class="password-toggle"
        aria-label="Afficher/Masquer le mot de passe"
        data-password-toggle
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"
          />
        </svg>
      </button>
    )
  }

  {
    error && (
      <span class="input-error-message" id={`${id}-error`} role="alert">
        {error}
      </span>
    )
  }
</div>

<script>
  function setupPasswordToggles() {
    const toggles = document.querySelectorAll("[data-password-toggle]");
    toggles.forEach((btn) => {
      // Prevent duplicate listeners
      if (btn.hasAttribute("data-init")) return;
      btn.setAttribute("data-init", "true");

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const button = e.currentTarget as HTMLButtonElement;
        const inputContainer = button.closest(".password-input-wrapper");
        const input = inputContainer?.querySelector("input");
        const svgPath = button.querySelector("path");

        if (input && svgPath) {
          const isPassword = input.type === "password";
          input.type = isPassword ? "text" : "password";

          // Switch icons (Eye vs EyeOff)
          if (isPassword) {
            // Show password (current is hidden) -> Open Eye
            svgPath.setAttribute(
              "d",
              "M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5",
            );
          } else {
            // Hide password (current is visible) -> Slash Eye
            svgPath.setAttribute(
              "d",
              "M11.83 9L15 12.16V12a3 3 0 0 0-3-3h-.17m-4.3.8l1.55 1.55c-.05.21-.08.42-.08.65a3 3 0 0 0 3 3c.22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53a5 5 0 0 1-5-5c0-.79.2-1.53.53-2.2M2 4.27l2.28 2.28l.45.45A11.8 11.8 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5c1.55 0 3.03-.3 4.38-.84l.43.42L19.73 22L21 20.73L3.27 3M12 7a5 5 0 0 1 5 5c0 .64-.13 1.26-.36 1.82l2.93 2.93c1.5-1.25 2.7-2.89 3.43-4.75c-1.73-4.39-6-7.5-11-7.5c-1.4 0-2.74.25-4 .7l2.17 2.15C10.74 7.13 11.35 7 12 7",
            );
          }
        }
      });
    });
  }

  // Run on load
  setupPasswordToggles();
  // Run on storage/view transitions
  document.addEventListener("astro:page-load", setupPasswordToggles);
</script>
