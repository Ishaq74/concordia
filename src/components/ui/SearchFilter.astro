---
// SearchFilter molecule for search and filter UI
export interface Filter {
  id: string;
  label: string;
  type: 'text' | 'select' | 'checkbox' | 'radio';
  options?: { value: string; label: string }[];
  placeholder?: string;
  value?: any;
}

export interface Props {
  filters: Filter[];
  onFilter?: (filters: Record<string, any>) => void;
  searchPlaceholder?: string;
  showSearch?: boolean;
  class?: string;
}

const {
  filters = [],
  onFilter,
  searchPlaceholder = "Rechercher...",
  showSearch = true,
  class: className = '',
} = Astro.props;
---

<div class={`search-filter ${className}`}>
  {showSearch && (
    <div class="search-filter-search">
      <input
        type="text"
        placeholder={searchPlaceholder}
        class="search-input"
        id="search-filter-query"
      />
      <button type="button" class="search-btn" id="search-filter-submit">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
      </button>
    </div>
  )}

  {filters.length > 0 && (
    <div class="search-filter-filters">
      {filters.map(filter => (
        <div class="filter-group">
          <label for={`filter-${filter.id}`} class="filter-label">
            {filter.label}
          </label>

          {filter.type === 'text' && (
            <input
              type="text"
              id={`filter-${filter.id}`}
              placeholder={filter.placeholder}
              value={filter.value || ''}
              class="filter-input"
              data-filter-id={filter.id}
            />
          )}

          {filter.type === 'select' && filter.options && (
            <select
              id={`filter-${filter.id}`}
              class="filter-select"
              data-filter-id={filter.id}
            >
              <option value="">Tous</option>
              {filter.options.map(option => (
                <option
                  value={option.value}
                  selected={filter.value === option.value}
                >
                  {option.label}
                </option>
              ))}
            </select>
          )}

          {filter.type === 'checkbox' && filter.options && (
            <div class="filter-checkboxes">
              {filter.options.map(option => (
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    value={option.value}
                    checked={filter.value?.includes(option.value)}
                    data-filter-id={filter.id}
                  />
                  <span>{option.label}</span>
                </label>
              ))}
            </div>
          )}

          {filter.type === 'radio' && filter.options && (
            <div class="filter-radios">
              {filter.options.map(option => (
                <label class="radio-label">
                  <input
                    type="radio"
                    name={`filter-${filter.id}`}
                    value={option.value}
                    checked={filter.value === option.value}
                    data-filter-id={filter.id}
                  />
                  <span>{option.label}</span>
                </label>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  )}

  <div class="search-filter-actions">
    <button type="button" class="filter-btn filter-btn-secondary" id="search-filter-reset">
      RÃ©initialiser
    </button>
    <button type="button" class="filter-btn filter-btn-primary" id="search-filter-apply">
      Appliquer
    </button>
  </div>
</div>

<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-filter-query') as HTMLInputElement;
    const searchBtn = document.getElementById('search-filter-submit') as HTMLButtonElement;
    const resetBtn = document.getElementById('search-filter-reset') as HTMLButtonElement;
    const applyBtn = document.getElementById('search-filter-apply') as HTMLButtonElement;

    function collectFilters(): Record<string, any> {
      const filters: Record<string, any> = {};

      // Collect search
      if (searchInput?.value) {
        filters.search = searchInput.value;
      }

      // Collect other filters
      document.querySelectorAll('[data-filter-id]').forEach((element) => {
        const filterId = element.getAttribute('data-filter-id');
        if (!filterId) return;

        if (element instanceof HTMLInputElement) {
          if (element.type === 'checkbox') {
            if (element.checked) {
              if (!filters[filterId]) filters[filterId] = [];
              filters[filterId].push(element.value);
            }
          } else if (element.type === 'radio') {
            if (element.checked) {
              filters[filterId] = element.value;
            }
          } else if (element.type === 'text' && element.value) {
            filters[filterId] = element.value;
          }
        } else if (element instanceof HTMLSelectElement && element.value) {
          filters[filterId] = element.value;
        }
      });

      return filters;
    }

    function applyFilters() {
      const filters = collectFilters();
      // Dispatch custom event for parent components to handle
      window.dispatchEvent(new CustomEvent('searchFilterChange', { detail: filters }));
    }

    function resetFilters() {
      // Reset search
      if (searchInput) searchInput.value = '';

      // Reset other filters
      document.querySelectorAll('[data-filter-id]').forEach((element) => {
        if (element instanceof HTMLInputElement) {
          if (element.type === 'checkbox' || element.type === 'radio') {
            element.checked = false;
          } else if (element.type === 'text') {
            element.value = '';
          }
        } else if (element instanceof HTMLSelectElement) {
          element.value = '';
        }
      });

      applyFilters();
    }

    // Event listeners
    if (searchBtn) {
      searchBtn.addEventListener('click', applyFilters);
    }

    if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyFilters();
        }
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener('click', resetFilters);
    }

    if (applyBtn) {
      applyBtn.addEventListener('click', applyFilters);
    }

    // Auto-apply on filter changes
    document.querySelectorAll('[data-filter-id]').forEach((element) => {
      element.addEventListener('change', () => {
        // Debounce for better UX
        setTimeout(applyFilters, 300);
      });
    });
  });
</script>

<style>
  .search-filter {
    background: var(--bg-surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
  }

  .search-filter-search {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .search-input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  .search-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3);
    background: var(--color-primary-600);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-all);
  }

  .search-btn:hover {
    background: var(--color-primary-700);
  }

  .search-filter-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .filter-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
  }

  .filter-input,
  .filter-select {
    padding: var(--space-3);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .filter-input:focus,
  .filter-select:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  .filter-checkboxes,
  .filter-radios {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .checkbox-label,
  .radio-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    font-size: var(--font-size-base);
    color: var(--text-primary);
  }

  .checkbox-label input,
  .radio-label input {
    width: 1rem;
    height: 1rem;
  }

  .search-filter-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
  }

  .filter-btn {
    padding: var(--space-3) var(--space-6);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: var(--transition-all);
  }

  .filter-btn-primary {
    background: var(--color-primary-600);
    color: white;
    border-color: var(--color-primary-600);
  }

  .filter-btn-primary:hover {
    background: var(--color-primary-700);
    border-color: var(--color-primary-700);
  }

  .filter-btn-secondary {
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .filter-btn-secondary:hover {
    background: var(--bg-secondary);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .search-filter-search {
      flex-direction: column;
    }

    .search-filter-filters {
      grid-template-columns: 1fr;
    }

    .search-filter-actions {
      flex-direction: column;
    }

    .filter-btn {
      width: 100%;
    }
  }
</style>