---
import { getEntry } from "astro:content";
import MarkdownIt from "markdown-it";
import BlogLayout from "@components/templates/blog/BlogLayout.astro";
import Grid from "@components/Tools/Grid.astro";
import Flex from "@components/Tools/Flex.astro";
// Import des composants
import PostHeader from "@components/modules/blog/single/PostHeader.astro";
import TableOfContents from "@components/modules/blog/single/TableOfContents.astro";
import AuthorCard from "@components/modules/blog/cards/AuthorCard.astro";
import ShareButtons from "@components/modules/blog/ui/ShareButtons.astro";
import PostComments from "@components/modules/blog/single/PostComments.astro";

const { slug } = Astro.params;
const LANG = "es";

const post = await getEntry("blog", `${slug}-${LANG}`);

if (!post) {
  return Astro.redirect("/404");
}

// Le contenu est du Markdown (sécurisé selon toi).
// Convertir en HTML côté serveur avec markdown-it.
const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true,
});
const renderedHtml = md.render(String(post.data.content ?? ""));

---


<BlogLayout
  title={post.data.seo?.title || post.data.title}
  description={post.data.seo?.description || post.data.excerpt}
  variant="initial"
>
  <main class="page-container">
    <PostHeader post={post} lang={LANG} />

    <article class="content-column">
      <TableOfContents />

      <!-- Insertion directe du HTML rendu (trusted content selon toi) -->
      <article class="post-content" role="article" set:html={renderedHtml}></article>

      <Flex gap="md" alignItems="center" justifyContent="space-between">
        <p class="article-cta-title">¿Te ha gustado este artículo?</p>
        <ShareButtons variant="retro" title={post.data.title} />
      </Flex>

      <Grid tag="div" variant="retro" align="center" textAlign="center" gap="md" marginTop="lg">
        {post.data.authors.map((author: any) => (
          <AuthorCard author={author} lang={LANG} />
        ))}
      </Grid>

      <section id="comments" class="article-comments">
        <PostComments entityId={post.data.id} entityType="blog" />
      </section>
    </article>
  </main>

  <style>
    .page-container{max-width:1200px;margin:0 auto;padding:3rem 1rem}
    .content-column{max-width:68ch;margin:0 auto}

    .article-cta{display:flex;flex-direction:column;gap:var(--space-3);align-items:flex-start;background:var(--muted-bg);padding:var(--space-4);border-radius:var(--card-border-radius);margin:2rem 0}
    @media(min-width:640px){.article-cta{flex-direction:row;justify-content:space-between;align-items:center}}
    .article-cta-title{font-weight:700;margin:0}
    .article-authors{margin-top:2rem;display:flex;flex-direction:column;gap:var(--space-4)}
    .article-comments{margin-top:2rem}
  </style>
</BlogLayout>