---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { mediationCase } from "@database/schemas";
import { eq, or, desc } from "drizzle-orm";
import translations from "@i18n/fr.json";

const t = translations;
const db = await getDrizzle();
const user = Astro.locals.user!;

const cases = await db
  .select({
    id: mediationCase.id,
    title: mediationCase.title,
    description: mediationCase.description,
    category: mediationCase.category,
    priority: mediationCase.priority,
    status: mediationCase.status,
    openedAt: mediationCase.openedAt,
    resolvedAt: mediationCase.resolvedAt,
  })
  .from(mediationCase)
  .where(or(eq(mediationCase.reporterId, user.id), eq(mediationCase.reportedUserId, user.id)))
  .orderBy(desc(mediationCase.openedAt));

const statusLabels: Record<string, string> = {
  opened: "Ouvert",
  assigned: "Assigné",
  in_progress: "En cours",
  resolved: "Résolu",
  failed: "Échoué",
  closed: "Fermé",
};

const priorityLabels: Record<string, string> = {
  low: "Faible",
  normal: "Normal",
  high: "Élevée",
  urgent: "Urgent",
};
---

<DashboardLayout title={t.dashboard.mediation} activeSection="mediation">
  <h1>{t.dashboard.mediation}</h1>

  {cases.length === 0 ? (
    <p class="empty">Aucun dossier de médiation.</p>
  ) : (
    <ul class="case-list" role="list">
      {cases.map((c) => (
        <li class="case-card">
          <div class="case-header">
            <h2 class="case-title">{c.title}</h2>
            <div class="case-badges">
              <span class:list={["status-badge", c.status]}>{statusLabels[c.status] ?? c.status}</span>
              <span class:list={["priority-badge", c.priority]}>{priorityLabels[c.priority] ?? c.priority}</span>
            </div>
          </div>
          {c.description && <p class="case-description">{c.description}</p>}
          <div class="case-meta">
            {c.category && <span>Catégorie : {c.category}</span>}
            <span>Ouvert le {new Date(c.openedAt).toLocaleDateString("fr-FR")}</span>
            {c.resolvedAt && <span>Résolu le {new Date(c.resolvedAt).toLocaleDateString("fr-FR")}</span>}
          </div>
        </li>
      ))}
    </ul>
  )}
</DashboardLayout>

<style>
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0 0 var(--space-6, 1.5rem); }
  .empty { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); }
  .case-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-3, 0.75rem); }
  .case-card { border: 1px solid var(--border-color, #e2e8f0); border-radius: var(--radius-md, 0.375rem); padding: var(--space-4, 1rem); }
  .case-header { display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-2, 0.5rem); margin-bottom: var(--space-2, 0.5rem); }
  .case-title { font-size: var(--text-base, 1rem); font-weight: 600; margin: 0; }
  .case-badges { display: flex; gap: var(--space-1, 0.25rem); flex-shrink: 0; }
  .status-badge { font-size: var(--text-xs, 0.75rem); padding: 1px var(--space-2, 0.5rem); border-radius: var(--radius-sm, 0.25rem); font-weight: 600; }
  .status-badge.opened { background: #fef9c3; color: #854d0e; }
  .status-badge.assigned { background: #dbeafe; color: #1e40af; }
  .status-badge.in_progress { background: #e0e7ff; color: #3730a3; }
  .status-badge.resolved { background: #dcfce7; color: #166534; }
  .status-badge.failed { background: #fecaca; color: #991b1b; }
  .status-badge.closed { background: #e2e8f0; color: #475569; }
  .priority-badge { font-size: var(--text-xs, 0.75rem); padding: 1px var(--space-2, 0.5rem); border-radius: var(--radius-sm, 0.25rem); font-weight: 600; }
  .priority-badge.low { background: #e2e8f0; color: #475569; }
  .priority-badge.normal { background: #dbeafe; color: #1e40af; }
  .priority-badge.high { background: #fed7aa; color: #c2410c; }
  .priority-badge.urgent { background: #fecaca; color: #991b1b; }
  .case-description { font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); margin: 0 0 var(--space-2, 0.5rem); }
  .case-meta { display: flex; gap: var(--space-3, 0.75rem); font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); flex-wrap: wrap; }
</style>
