---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { notification } from "@database/schemas";
import { eq, desc, sql, and } from "drizzle-orm";
import translations from "@i18n/fr.json";

const t = translations;
const db = await getDrizzle();
const user = Astro.locals.user!;

const url = new URL(Astro.request.url);
const filter = url.searchParams.get("filter") ?? "all";

const conditions = [eq(notification.userId, user.id)];
if (filter === "unread") {
  conditions.push(eq(notification.isRead, false));
}

const notifications = await db
  .select({
    id: notification.id,
    type: notification.type,
    title: notification.title,
    body: notification.body,
    targetType: notification.targetType,
    targetId: notification.targetId,
    isRead: notification.isRead,
    createdAt: notification.createdAt,
  })
  .from(notification)
  .where(and(...conditions))
  .orderBy(desc(notification.createdAt))
  .limit(50);

const unreadCount = await db
  .select({ count: sql<number>`count(*)::int` })
  .from(notification)
  .where(and(eq(notification.userId, user.id), eq(notification.isRead, false)));

const typeIcons: Record<string, string> = {
  review: "‚≠ê",
  message: "üí¨",
  booking: "üìÖ",
  moderation: "üõ°Ô∏è",
  mediation: "‚öñÔ∏è",
  system: "‚öôÔ∏è",
  donation: "üí∞",
  education: "üìö",
  volunteer: "ü§ù",
};
---

<DashboardLayout title={t.dashboard.notifications} activeSection="notifications">
  <div class="notif-header">
    <h1>{t.dashboard.notifications}</h1>
    {unreadCount[0].count > 0 && (
      <a href="/api/notifications?action=mark-all-read" class="mark-all-read">
        {t.dashboard.markAllRead}
      </a>
    )}
  </div>

  <nav class="filter-tabs" aria-label="Filtrer">
    <a href="?filter=all" class:list={["tab", { active: filter === "all" }]}>Toutes</a>
    <a href="?filter=unread" class:list={["tab", { active: filter === "unread" }]}>
      {t.dashboard.unread} ({unreadCount[0].count})
    </a>
  </nav>

  {notifications.length === 0 ? (
    <p class="empty">{t.dashboard.noNotifications}</p>
  ) : (
    <ul class="notif-list" role="list">
      {notifications.map((n) => (
        <li class:list={["notif-item", { unread: !n.isRead }]}>
          <span class="notif-icon">{typeIcons[n.type] ?? "üìå"}</span>
          <div class="notif-content">
            <div class="notif-title-row">
              <span class="notif-title">{n.title}</span>
              <span class="notif-date">
                {new Date(n.createdAt).toLocaleDateString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })}
              </span>
            </div>
            {n.body && <p class="notif-body">{n.body}</p>}
          </div>
        </li>
      ))}
    </ul>
  )}
</DashboardLayout>

<style>
  .notif-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4, 1rem); }
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0; }
  .mark-all-read { font-size: var(--text-sm, 0.875rem); color: var(--color-primary, #3b82f6); text-decoration: none; font-weight: 500; }
  .filter-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border-color, #e2e8f0); margin-bottom: var(--space-4, 1rem); }
  .tab { padding: var(--space-2, 0.5rem) var(--space-4, 1rem); text-decoration: none; font-size: var(--text-sm, 0.875rem); font-weight: 500; color: var(--text-secondary, #64748b); border-bottom: 2px solid transparent; margin-bottom: -2px; }
  .tab:hover { color: var(--text-primary, #1e293b); }
  .tab.active { color: var(--color-primary, #3b82f6); border-bottom-color: var(--color-primary, #3b82f6); }
  .empty { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); }
  .notif-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
  .notif-item { display: flex; gap: var(--space-3, 0.75rem); padding: var(--space-3, 0.75rem); border-bottom: 1px solid var(--border-color, #e2e8f0); }
  .notif-item.unread { background: var(--bg-active, #eff6ff); }
  .notif-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 2px; }
  .notif-content { flex: 1; min-width: 0; }
  .notif-title-row { display: flex; justify-content: space-between; align-items: center; gap: var(--space-2, 0.5rem); }
  .notif-title { font-size: var(--text-sm, 0.875rem); font-weight: 600; }
  .notif-date { font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); white-space: nowrap; }
  .notif-body { font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); margin: 2px 0 0; }
</style>
