---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { booking, localService } from "@database/schemas";
import { eq, desc, and, sql, gte, lt } from "drizzle-orm";
import translations from "@i18n/fr.json";

const t = translations;
const db = await getDrizzle();
const user = Astro.locals.user!;

const url = new URL(Astro.request.url);
const tab = url.searchParams.get("tab") ?? "upcoming";

const today = new Date().toISOString().split("T")[0];

const baseCondition = eq(booking.customerId, user.id);

let filterCondition;
if (tab === "past") {
  filterCondition = and(baseCondition, lt(booking.bookingDate, today));
} else if (tab === "cancelled") {
  filterCondition = and(baseCondition, sql`${booking.status} IN ('cancelled_by_client', 'cancelled_by_provider')`);
} else {
  filterCondition = and(baseCondition, gte(booking.bookingDate, today), sql`${booking.status} NOT IN ('cancelled_by_client', 'cancelled_by_provider')`);
}

const bookings = await db
  .select({
    id: booking.id,
    bookingDate: booking.bookingDate,
    bookingTime: booking.bookingTime,
    durationMinutes: booking.durationMinutes,
    totalPrice: booking.totalPrice,
    status: booking.status,
    customerMessage: booking.customerMessage,
    providerResponse: booking.providerResponse,
    serviceName: localService.title,
    createdAt: booking.createdAt,
  })
  .from(booking)
  .innerJoin(localService, eq(booking.serviceId, localService.id))
  .where(filterCondition)
  .orderBy(desc(booking.bookingDate));

const statusLabels: Record<string, string> = {
  pending: "En attente",
  confirmed: "Confirm√©",
  cancelled_by_client: "Annul√© par vous",
  cancelled_by_provider: "Annul√© par le prestataire",
  completed: "Termin√©",
  no_show: "Absent",
};

const tabs = [
  { key: "upcoming", label: t.dashboard.upcomingBookings },
  { key: "past", label: t.dashboard.pastBookings },
  { key: "cancelled", label: t.dashboard.cancelledBookings },
];
---

<DashboardLayout title={t.dashboard.myBookings} activeSection="bookings">
  <h1>{t.dashboard.myBookings}</h1>

  <nav class="tabs" aria-label="Filtrer les r√©servations">
    {tabs.map((t) => (
      <a
        href={`?tab=${t.key}`}
        class:list={["tab-link", { active: tab === t.key }]}
        aria-current={tab === t.key ? "page" : undefined}
      >
        {t.label}
      </a>
    ))}
  </nav>

  {bookings.length === 0 ? (
    <p class="empty">{t.dashboard.noBookings}</p>
  ) : (
    <ul class="booking-list" role="list">
      {bookings.map((b) => (
        <li class="booking-card">
          <div class="booking-header">
            <h2 class="booking-service">{b.serviceName}</h2>
            <span class:list={["status-badge", b.status]}>
              {statusLabels[b.status] ?? b.status}
            </span>
          </div>
          <div class="booking-details">
            <span>üìÖ {new Date(b.bookingDate).toLocaleDateString("fr-FR", { weekday: "long", day: "numeric", month: "long", year: "numeric" })}</span>
            <span>‚è∞ {b.bookingTime}</span>
            <span>‚è±Ô∏è {b.durationMinutes} min</span>
            {b.totalPrice && <span>üí∞ {Number(b.totalPrice).toFixed(2)} ‚Ç¨</span>}
          </div>
          {b.customerMessage && (
            <p class="booking-message"><strong>Votre message :</strong> {b.customerMessage}</p>
          )}
          {b.providerResponse && (
            <p class="booking-response"><strong>R√©ponse :</strong> {b.providerResponse}</p>
          )}
        </li>
      ))}
    </ul>
  )}
</DashboardLayout>

<style>
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0 0 var(--space-4, 1rem); }
  .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border-color, #e2e8f0); margin-bottom: var(--space-4, 1rem); }
  .tab-link { padding: var(--space-2, 0.5rem) var(--space-4, 1rem); text-decoration: none; font-size: var(--text-sm, 0.875rem); font-weight: 500; color: var(--text-secondary, #64748b); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: color 0.15s; }
  .tab-link:hover { color: var(--text-primary, #1e293b); }
  .tab-link.active { color: var(--color-primary, #3b82f6); border-bottom-color: var(--color-primary, #3b82f6); }
  .empty { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); }
  .booking-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-3, 0.75rem); }
  .booking-card { border: 1px solid var(--border-color, #e2e8f0); border-radius: var(--radius-md, 0.375rem); padding: var(--space-4, 1rem); }
  .booking-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-2, 0.5rem); }
  .booking-service { font-size: var(--text-base, 1rem); font-weight: 600; margin: 0; }
  .status-badge { font-size: var(--text-xs, 0.75rem); padding: 2px var(--space-2, 0.5rem); border-radius: var(--radius-sm, 0.25rem); font-weight: 600; white-space: nowrap; }
  .status-badge.pending { background: #fef9c3; color: #854d0e; }
  .status-badge.confirmed { background: #dcfce7; color: #166534; }
  .status-badge.completed { background: #dbeafe; color: #1e40af; }
  .status-badge.cancelled_by_client, .status-badge.cancelled_by_provider { background: #fecaca; color: #991b1b; }
  .status-badge.no_show { background: #e2e8f0; color: #475569; }
  .booking-details { display: flex; gap: var(--space-3, 0.75rem); font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); flex-wrap: wrap; }
  .booking-message, .booking-response { font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); margin: var(--space-2, 0.5rem) 0 0; }
</style>
