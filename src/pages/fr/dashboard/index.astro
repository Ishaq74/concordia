---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { notification, conversation, conversationParticipant, booking, wallet, mediationCase, favorite } from "@database/schemas";
import { eq, and, desc, sql, gte } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const user = Astro.locals.user!;

const today = new Date().toISOString().split("T")[0];

const [
  unreadNotifResult,
  unreadMsgResult,
  upcomingBookingsResult,
  walletResult,
  activeCasesResult,
  favoritesResult,
] = await Promise.all([
  db.select({ count: sql<number>`count(*)::int` })
    .from(notification)
    .where(and(eq(notification.userId, user.id), eq(notification.isRead, false))),
  db.select({ count: sql<number>`count(*)::int` })
    .from(conversationParticipant)
    .innerJoin(conversation, eq(conversationParticipant.conversationId, conversation.id))
    .where(and(
      eq(conversationParticipant.userId, user.id),
      sql`${conversation.lastMessageAt} > COALESCE(${conversationParticipant.lastReadAt}, '1970-01-01'::timestamp)`,
    )),
  db.select({ count: sql<number>`count(*)::int` })
    .from(booking)
    .where(and(
      eq(booking.customerId, user.id),
      gte(booking.bookingDate, today),
      sql`${booking.status} NOT IN ('cancelled_by_client', 'cancelled_by_provider')`,
    )),
  db.select({ balance: wallet.balance, currency: wallet.currency })
    .from(wallet)
    .where(eq(wallet.userId, user.id))
    .limit(1),
  db.select({ count: sql<number>`count(*)::int` })
    .from(mediationCase)
    .where(and(
      sql`(${mediationCase.reporterId} = ${user.id} OR ${mediationCase.reportedUserId} = ${user.id})`,
      sql`${mediationCase.status} NOT IN ('resolved', 'failed', 'closed')`,
    )),
  db.select({ count: sql<number>`count(*)::int` })
    .from(favorite)
    .where(eq(favorite.userId, user.id)),
]);

const stats = {
  unreadNotifications: unreadNotifResult[0].count,
  unreadMessages: unreadMsgResult[0].count,
  upcomingBookings: upcomingBookingsResult[0].count,
  walletBalance: walletResult[0] ? Number(walletResult[0].balance) : 0,
  walletCurrency: walletResult[0]?.currency ?? "EUR",
  activeCases: activeCasesResult[0].count,
  favorites: favoritesResult[0].count,
};

const recentNotifications = await db
  .select({
    id: notification.id,
    type: notification.type,
    title: notification.title,
    body: notification.body,
    isRead: notification.isRead,
    createdAt: notification.createdAt,
  })
  .from(notification)
  .where(eq(notification.userId, user.id))
  .orderBy(desc(notification.createdAt))
  .limit(5);
---

<DashboardLayout title={t.dashboard.title} activeSection="profile">
  <h1>{t.dashboard.title}</h1>
  <p class="welcome">Bienvenue, <strong>{user.name}</strong></p>

  <section class="stats-grid" aria-label="R√©sum√©">
    <div class="stat-card">
      <span class="stat-icon">üîî</span>
      <span class="stat-value">{stats.unreadNotifications}</span>
      <span class="stat-label">{t.dashboard.notifications} non lues</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/notifications")} class="stat-link">{t.common.viewAll}</a>
    </div>
    <div class="stat-card">
      <span class="stat-icon">üí¨</span>
      <span class="stat-value">{stats.unreadMessages}</span>
      <span class="stat-label">{t.dashboard.messages} non lus</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/messages")} class="stat-link">{t.common.viewAll}</a>
    </div>
    <div class="stat-card">
      <span class="stat-icon">üìÖ</span>
      <span class="stat-value">{stats.upcomingBookings}</span>
      <span class="stat-label">{t.dashboard.upcomingBookings}</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/bookings")} class="stat-link">{t.common.viewAll}</a>
    </div>
    <div class="stat-card">
      <span class="stat-icon">üí∞</span>
      <span class="stat-value">{stats.walletBalance.toLocaleString("fr-FR")} {stats.walletCurrency}</span>
      <span class="stat-label">{t.dashboard.balance}</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/wallet")} class="stat-link">{t.common.viewAll}</a>
    </div>
    <div class="stat-card">
      <span class="stat-icon">‚öñÔ∏è</span>
      <span class="stat-value">{stats.activeCases}</span>
      <span class="stat-label">{t.dashboard.mediation}</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/mediation")} class="stat-link">{t.common.viewAll}</a>
    </div>
    <div class="stat-card">
      <span class="stat-icon">‚ù§Ô∏è</span>
      <span class="stat-value">{stats.favorites}</span>
      <span class="stat-label">{t.dashboard.favorites}</span>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/favorites")} class="stat-link">{t.common.viewAll}</a>
    </div>
  </section>

  {recentNotifications.length > 0 && (
    <section class="recent-notifications" aria-label="Notifications r√©centes">
      <h2>Notifications r√©centes</h2>
      <ul class="notif-list" role="list">
        {recentNotifications.map((n) => (
          <li class:list={["notif-item", { unread: !n.isRead }]}>
            <div class="notif-header">
              <span class="notif-title">{n.title}</span>
              <span class="notif-date">{new Date(n.createdAt).toLocaleDateString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })}</span>
            </div>
            {n.body && <p class="notif-body">{n.body}</p>}
          </li>
        ))}
      </ul>
      <a href={getRelativeLocaleUrl(locale, "/dashboard/notifications")} class="view-all-link">{t.common.viewAll} ‚Üí</a>
    </section>
  )}
</DashboardLayout>

<style>
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0; }
  .welcome { color: var(--text-secondary, #64748b); margin: var(--space-1, 0.25rem) 0 var(--space-6, 1.5rem); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-3, 0.75rem); margin-bottom: var(--space-6, 1.5rem); }
  .stat-card { border: 1px solid var(--border-color, #e2e8f0); border-radius: var(--radius-lg, 0.5rem); padding: var(--space-4, 1rem); display: flex; flex-direction: column; align-items: center; text-align: center; }
  .stat-icon { font-size: 1.5rem; margin-bottom: var(--space-1, 0.25rem); }
  .stat-value { font-size: var(--text-2xl, 1.5rem); font-weight: 800; }
  .stat-label { font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); margin-bottom: var(--space-2, 0.5rem); }
  .stat-link { font-size: var(--text-xs, 0.75rem); color: var(--color-primary, #3b82f6); text-decoration: none; font-weight: 500; }

  .recent-notifications h2 { font-size: var(--text-lg, 1.125rem); font-weight: 700; margin: 0 0 var(--space-3, 0.75rem); }
  .notif-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
  .notif-item { padding: var(--space-2, 0.5rem) var(--space-3, 0.75rem); border-bottom: 1px solid var(--border-color, #e2e8f0); }
  .notif-item.unread { background: var(--bg-active, #eff6ff); }
  .notif-header { display: flex; justify-content: space-between; align-items: center; }
  .notif-title { font-size: var(--text-sm, 0.875rem); font-weight: 600; }
  .notif-date { font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); }
  .notif-body { font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); margin: 2px 0 0; }
  .view-all-link { display: inline-block; margin-top: var(--space-3, 0.75rem); font-size: var(--text-sm, 0.875rem); color: var(--color-primary, #3b82f6); text-decoration: none; font-weight: 500; }
</style>
