---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { conversation, conversationParticipant, message } from "@database/schemas";
import { eq, desc, sql, and } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const user = Astro.locals.user!;

const userConversations = await db
  .select({
    conversationId: conversationParticipant.conversationId,
    role: conversationParticipant.role,
    lastReadAt: conversationParticipant.lastReadAt,
    convType: conversation.type,
    convSubject: conversation.subject,
    lastMessageAt: conversation.lastMessageAt,
  })
  .from(conversationParticipant)
  .innerJoin(conversation, eq(conversationParticipant.conversationId, conversation.id))
  .where(eq(conversationParticipant.userId, user.id))
  .orderBy(desc(conversation.lastMessageAt));

const conversationsWithPreview = await Promise.all(
  userConversations.map(async (c) => {
    const lastMsg = await db
      .select({ content: message.content, senderId: message.senderId, sentAt: message.sentAt })
      .from(message)
      .where(eq(message.conversationId, c.conversationId))
      .orderBy(desc(message.sentAt))
      .limit(1);

    const unreadCount = c.lastReadAt
      ? await db
          .select({ count: sql<number>`count(*)::int` })
          .from(message)
          .where(and(
            eq(message.conversationId, c.conversationId),
            sql`${message.sentAt} > ${c.lastReadAt}`,
            sql`${message.senderId} != ${user.id}`,
          ))
      : [{ count: 0 }];

    return {
      ...c,
      lastMessage: lastMsg[0] ?? null,
      unreadCount: unreadCount[0]?.count ?? 0,
    };
  }),
);

const typeLabels: Record<string, string> = {
  direct: "Direct",
  group: "Groupe",
  classified_contact: "Annonce",
  mediation: "MÃ©diation",
};
---

<DashboardLayout title={t.dashboard.messages} activeSection="messages">
  <div class="messages-header">
    <h1>{t.dashboard.messages}</h1>
  </div>

  {conversationsWithPreview.length === 0 ? (
    <p class="empty">{t.dashboard.noMessages}</p>
  ) : (
    <ul class="conversation-list" role="list">
      {conversationsWithPreview.map((c) => (
        <li class:list={["conversation-item", { unread: c.unreadCount > 0 }]}>
          <a href={getRelativeLocaleUrl(locale, `/dashboard/messages/${c.conversationId}`)} class="conversation-link">
            <div class="conversation-header">
              <span class="conversation-subject">
                {c.convSubject ?? typeLabels[c.convType] ?? "Conversation"}
              </span>
              {c.unreadCount > 0 && (
                <span class="unread-badge">{c.unreadCount}</span>
              )}
            </div>
            {c.lastMessage && (
              <p class="conversation-preview">{c.lastMessage.content}</p>
            )}
            <div class="conversation-meta">
              <span class="conversation-type">{typeLabels[c.convType] ?? c.convType}</span>
              {c.lastMessageAt && (
                <span class="conversation-date">
                  {new Date(c.lastMessageAt).toLocaleDateString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })}
                </span>
              )}
            </div>
          </a>
        </li>
      ))}
    </ul>
  )}
</DashboardLayout>

<style>
  .messages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4, 1rem); }
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0; }
  .empty { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); }
  .conversation-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
  .conversation-item { border-bottom: 1px solid var(--border-color, #e2e8f0); }
  .conversation-item:first-child { border-top: 1px solid var(--border-color, #e2e8f0); }
  .conversation-item.unread { background: var(--bg-active, #eff6ff); }
  .conversation-link { display: block; padding: var(--space-3, 0.75rem) var(--space-4, 1rem); text-decoration: none; color: inherit; transition: background 0.15s; }
  .conversation-link:hover { background: var(--bg-hover, #f1f5f9); }
  .conversation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
  .conversation-subject { font-weight: 600; font-size: var(--text-sm, 0.875rem); }
  .unread-badge { background: var(--color-primary, #3b82f6); color: #fff; font-size: var(--text-xs, 0.75rem); font-weight: 700; padding: 0 6px; border-radius: 10px; min-width: 18px; text-align: center; }
  .conversation-preview { font-size: var(--text-sm, 0.875rem); color: var(--text-secondary, #64748b); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 600px; }
  .conversation-meta { display: flex; gap: var(--space-3, 0.75rem); font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); margin-top: 2px; }
</style>
