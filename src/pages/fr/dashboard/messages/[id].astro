---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { conversation, conversationParticipant, message } from "@database/schemas";
import { eq, asc, and } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const user = Astro.locals.user!;
const { id } = Astro.params;

if (!id) return Astro.redirect(getRelativeLocaleUrl(locale, "/dashboard/messages"));

const participantCheck = await db
  .select({ conversationId: conversationParticipant.conversationId })
  .from(conversationParticipant)
  .where(and(eq(conversationParticipant.conversationId, id), eq(conversationParticipant.userId, user.id)))
  .limit(1);

if (participantCheck.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/dashboard/messages"));

const convRows = await db.select().from(conversation).where(eq(conversation.id, id)).limit(1);
if (convRows.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/dashboard/messages"));
const conv = convRows[0];

const messages = await db
  .select({
    id: message.id,
    content: message.content,
    senderId: message.senderId,
    sentAt: message.sentAt,
  })
  .from(message)
  .where(eq(message.conversationId, id))
  .orderBy(asc(message.sentAt));

await db
  .update(conversationParticipant)
  .set({ lastReadAt: new Date() })
  .where(and(eq(conversationParticipant.conversationId, id), eq(conversationParticipant.userId, user.id)));
---

<DashboardLayout title={conv.subject ?? t.dashboard.messages} activeSection="messages">
  <div class="message-thread">
    <header class="thread-header">
      <a href={getRelativeLocaleUrl(locale, "/dashboard/messages")} class="back-link">← {t.common.back}</a>
      <h1>{conv.subject ?? "Conversation"}</h1>
    </header>

    <div class="messages-list" role="log" aria-label="Messages">
      {messages.length === 0 ? (
        <p class="empty">Aucun message pour le moment.</p>
      ) : (
        messages.map((msg) => (
          <div class:list={["message-bubble", { own: msg.senderId === user.id, other: msg.senderId !== user.id }]}>
            <div class="message-content">{msg.content}</div>
            <span class="message-time">
              {new Date(msg.sentAt).toLocaleString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })}
            </span>
          </div>
        ))
      )}
    </div>

    <form method="POST" action={`/api/messages/${id}`} class="reply-form">
      <textarea
        name="content"
        rows="3"
        required
        placeholder="Écrire un message..."
        aria-label="Écrire un message"
        class="reply-input"
      ></textarea>
      <button type="submit" class="send-button">{t.common.submit}</button>
    </form>
  </div>
</DashboardLayout>

<style>
  .message-thread { display: flex; flex-direction: column; height: calc(100vh - 200px); }
  .thread-header { margin-bottom: var(--space-4, 1rem); }
  .back-link { color: var(--color-primary, #3b82f6); text-decoration: none; font-size: var(--text-sm, 0.875rem); font-weight: 500; }
  h1 { font-size: var(--text-xl, 1.25rem); font-weight: 700; margin: var(--space-2, 0.5rem) 0 0; }

  .messages-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: var(--space-2, 0.5rem); padding: var(--space-4, 1rem) 0; }
  .empty { color: var(--text-secondary, #64748b); text-align: center; }

  .message-bubble { max-width: 70%; padding: var(--space-2, 0.5rem) var(--space-3, 0.75rem); border-radius: var(--radius-lg, 0.5rem); }
  .message-bubble.own { align-self: flex-end; background: var(--color-primary, #3b82f6); color: #fff; border-bottom-right-radius: 2px; }
  .message-bubble.other { align-self: flex-start; background: var(--bg-secondary, #f1f5f9); border-bottom-left-radius: 2px; }
  .message-content { font-size: var(--text-sm, 0.875rem); line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
  .message-time { font-size: var(--text-xs, 0.75rem); opacity: 0.7; display: block; margin-top: 2px; }
  .message-bubble.own .message-time { text-align: right; }

  .reply-form { display: flex; gap: var(--space-2, 0.5rem); align-items: flex-end; border-top: 1px solid var(--border-color, #e2e8f0); padding-top: var(--space-3, 0.75rem); }
  .reply-input { flex: 1; padding: var(--space-2, 0.5rem) var(--space-3, 0.75rem); border: 1px solid var(--border-color, #e2e8f0); border-radius: var(--radius-md, 0.375rem); font-size: var(--text-sm, 0.875rem); resize: vertical; font-family: inherit; }
  .send-button { padding: var(--space-2, 0.5rem) var(--space-4, 1rem); background: var(--color-primary, #3b82f6); color: #fff; border: none; border-radius: var(--radius-md, 0.375rem); cursor: pointer; font-weight: 600; white-space: nowrap; }
</style>
