---
export const prerender = false;

import DashboardLayout from "@layouts/DashboardLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { favorite } from "@database/schemas";
import { eq, desc } from "drizzle-orm";
import translations from "@i18n/fr.json";

const t = translations;
const db = await getDrizzle();
const user = Astro.locals.user!;

const favorites = await db
  .select({
    id: favorite.id,
    targetType: favorite.targetType,
    targetId: favorite.targetId,
    createdAt: favorite.createdAt,
  })
  .from(favorite)
  .where(eq(favorite.userId, user.id))
  .orderBy(desc(favorite.createdAt));

const typeLabels: Record<string, string> = {
  place: "Lieu",
  article: "Article",
  event: "Événement",
  service: "Service",
  classified: "Annonce",
  product: "Produit",
  module: "Module",
  project: "Projet",
  campaign: "Campagne",
};
---

<DashboardLayout title={t.dashboard.favorites} activeSection="favorites">
  <h1>{t.dashboard.favorites}</h1>

  {favorites.length === 0 ? (
    <p class="empty">{t.dashboard.noFavorites}</p>
  ) : (
    <ul class="favorites-list" role="list">
      {favorites.map((fav) => (
        <li class="favorite-item">
          <span class="fav-type">{typeLabels[fav.targetType] ?? fav.targetType}</span>
          <span class="fav-id">{fav.targetId}</span>
          <span class="fav-date">
            Ajouté le {new Date(fav.createdAt).toLocaleDateString("fr-FR")}
          </span>
        </li>
      ))}
    </ul>
  )}
</DashboardLayout>

<style>
  h1 { font-size: var(--text-2xl, 1.5rem); font-weight: 800; margin: 0 0 var(--space-4, 1rem); }
  .empty { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); }
  .favorites-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
  .favorite-item { display: flex; align-items: center; gap: var(--space-3, 0.75rem); padding: var(--space-3, 0.75rem); border-bottom: 1px solid var(--border-color, #e2e8f0); }
  .fav-type { font-size: var(--text-xs, 0.75rem); background: var(--bg-secondary, #f1f5f9); padding: 2px var(--space-2, 0.5rem); border-radius: var(--radius-sm, 0.25rem); font-weight: 600; flex-shrink: 0; }
  .fav-id { font-size: var(--text-sm, 0.875rem); font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .fav-date { font-size: var(--text-xs, 0.75rem); color: var(--text-muted, #94a3b8); flex-shrink: 0; }
</style>
