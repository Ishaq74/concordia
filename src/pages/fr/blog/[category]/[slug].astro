---
import { getEntry } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import Grid from "@components/Tools/Grid.astro";

// Import des composants
import PostHeader from "@components/modules/blog/single/PostHeader.astro";
import PostContent from "@components/modules/blog/single/PostContent.astro";
import TableOfContents from "@components/modules/blog/single/TableOfContents.astro";
import AuthorCard from "@components/modules/blog/cards/AuthorCard.astro";
import ShareButtons from "@components/modules/blog/ui/ShareButtons.astro";
import PostComments from "@components/modules/blog/single/PostComments.astro";

// 1. On récupère les paramètres de l'URL
const { slug } = Astro.params;
const LANG = "fr";

// 2. On va chercher l'article dans la collection "blog"
// Ton loader génère des IDs sous la forme "slug-lang"
const post = await getEntry("blog", `${slug}-${LANG}`);

// 3. Sécurité : Si l'article n'existe pas, on renvoie vers une 404
if (!post) {
  return Astro.redirect("/404");
}
---

<BaseLayout
  title={post.data.seo?.title || post.data.title}
  description={post.data.seo?.description || post.data.excerpt}
  lang={LANG}
>
  <main class="page-container">
    {/* 1. HEADER (Titre, Image, Méta) - Centré en haut */}
    <div class="page-header">
      <PostHeader post={post} lang={LANG} />
    </div>

    <Grid display="grid" gridTemplateColumns="200px 1fr 80px" gap="3rem" className="page-grid">
      <aside class="toc-column">
        <div class="toc-sticky">
          <TableOfContents />
        </div>
      </aside>

      <article class="content-column">
        <PostContent>
          <Fragment set:html={post.data.content} />
        </PostContent>

        <div class="article-cta">
          <p class="article-cta-title">Vous avez aimé cet article ?</p>
          <ShareButtons title={post.data.title} />
        </div>

        <div class="article-authors">
          {post.data.authors.map((author: any) => (
            <AuthorCard author={author} lang={LANG} />
          ))}
        </div>

        <section id="comments" class="article-comments">
          <PostComments entityId={post.data.id} entityType="blog" />
        </section>
      </article>

      <div class="spacer-column"></div>
    </Grid>
  </main>

  <style>
    .page-container{max-width:1200px;margin:0 auto;padding:3rem 1rem}
    .page-header{margin-bottom:2rem}
    .page-grid{display:grid;grid-template-columns:200px 1fr 80px;gap:3rem;align-items:start}
    .toc-column{display:none}
    @media(min-width:1024px){.toc-column{display:block}.toc-sticky{position:sticky;top:6rem}} 
    .content-column{max-width:68ch;margin:0 auto}
    .spacer-column{display:none}@media(min-width:1024px){.spacer-column{display:block}}

    .article-cta{display:flex;flex-direction:column;gap:var(--space-3);align-items:flex-start;background:var(--muted-bg);padding:var(--space-4);border-radius:var(--card-border-radius);margin:2rem 0}
    @media(min-width:640px){.article-cta{flex-direction:row;justify-content:space-between;align-items:center}}
    .article-cta-title{font-weight:700;margin:0}

    .article-authors{margin-top:2rem;display:flex;flex-direction:column;gap:var(--space-4)}
    .article-comments{margin-top:2rem}
  </style>
</BaseLayout>
