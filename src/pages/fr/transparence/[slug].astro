---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { transparencyReport } from "@database/schemas";
import { eq } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const { slug } = Astro.params;

if (!slug) return Astro.redirect(getRelativeLocaleUrl(locale, "/transparence"));

const rows = await db
  .select()
  .from(transparencyReport)
  .where(eq(transparencyReport.slug, slug))
  .limit(1);

if (rows.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/transparence"));

const report = rows[0];

if (report.status !== "published") return Astro.redirect(getRelativeLocaleUrl(locale, "/transparence"));

type ParagraphBlock = { type: "paragraph"; text: string };
type HeadingBlock = { type: "heading"; text: string; level?: number };
type ListBlock = { type: "list"; items: string[] };
type ImageBlock = { type: "image"; src: string; alt?: string; caption?: string };
type ContentBlock = ParagraphBlock | HeadingBlock | ListBlock | ImageBlock;
const contentBlocks: ContentBlock[] = Array.isArray(report.contentJson) ? report.contentJson as ContentBlock[] : [];
---

<BaseLayout title={report.title} description={`Rapport de transparence — ${report.title}`}>
  <main class="report-detail">
    <a href={getRelativeLocaleUrl(locale, "/transparence")} class="back-link">← {t.common.back}</a>

    <header class="report-header">
      <h1>{report.title}</h1>
      <div class="report-meta">
        <span>Période : {new Date(report.periodStart).toLocaleDateString("fr-FR")} — {new Date(report.periodEnd).toLocaleDateString("fr-FR")}</span>
        {report.publishedAt && <span>Publié le {new Date(report.publishedAt).toLocaleDateString("fr-FR")}</span>}
      </div>
    </header>

    <article class="report-content">
      {contentBlocks.map((block) => {
        if (block.type === "paragraph" && block.text) return <p>{block.text}</p>;
        if (block.type === "heading" && block.text) {
          const Tag = `h${block.level ?? 2}` as keyof HTMLElementTagNameMap;
          return <Tag>{block.text}</Tag>;
        }
        if (block.type === "list" && block.items) {
          return (
            <ul>
              {block.items.map((item: string) => <li>{item}</li>)}
            </ul>
          );
        }
        if (block.type === "image" && block.src) {
          return (
            <figure>
              <img src={block.src} alt={block.alt ?? ""} loading="lazy" />
              {block.caption && <figcaption>{block.caption}</figcaption>}
            </figure>
          );
        }
        return null;
      })}
    </article>
  </main>
</BaseLayout>

<style>
  .report-detail { max-width: 800px; margin: 0 auto; padding: var(--space-6, 1.5rem) var(--space-4, 1rem); }
  .back-link { color: var(--color-primary, #3b82f6); text-decoration: none; font-size: var(--text-sm, 0.875rem); font-weight: 500; display: inline-block; margin-bottom: var(--space-4, 1rem); }
  .report-header h1 { font-size: var(--text-3xl, 1.875rem); font-weight: 800; margin: 0 0 var(--space-2, 0.5rem); }
  .report-meta { display: flex; gap: var(--space-3, 0.75rem); font-size: var(--text-sm, 0.875rem); color: var(--text-muted, #94a3b8); margin-bottom: var(--space-6, 1.5rem); flex-wrap: wrap; }

  .report-content { line-height: 1.7; }
  .report-content p { margin: 0 0 var(--space-4, 1rem); font-size: var(--text-base, 1rem); }
  .report-content h2 { font-size: var(--text-xl, 1.25rem); font-weight: 700; margin: var(--space-6, 1.5rem) 0 var(--space-3, 0.75rem); }
  .report-content h3 { font-size: var(--text-lg, 1.125rem); font-weight: 600; margin: var(--space-4, 1rem) 0 var(--space-2, 0.5rem); }
  .report-content ul { padding-left: var(--space-6, 1.5rem); margin: 0 0 var(--space-4, 1rem); }
  .report-content li { margin-bottom: var(--space-1, 0.25rem); }
  .report-content figure { margin: var(--space-4, 1rem) 0; }
  .report-content img { max-width: 100%; height: auto; border-radius: var(--radius-md, 0.375rem); }
  .report-content figcaption { font-size: var(--text-sm, 0.875rem); color: var(--text-muted, #94a3b8); text-align: center; margin-top: var(--space-2, 0.5rem); }
</style>
