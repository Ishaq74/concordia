---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { article, articleContent, comment } from "@database/schemas";
import { eq, and, desc } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const { slug } = Astro.params;

if (!slug) return Astro.redirect(getRelativeLocaleUrl(locale, "/articles"));

const articleRows = await db
  .select()
  .from(article)
  .where(and(eq(article.slug, slug), eq(article.status, "published")))
  .limit(1);

if (articleRows.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/articles"));

const a = articleRows[0];

const contentRows = await db
  .select()
  .from(articleContent)
  .where(and(eq(articleContent.articleId, a.id), eq(articleContent.language, locale)))
  .limit(1);

const content = contentRows[0] ?? (
  await db
    .select()
    .from(articleContent)
    .where(and(eq(articleContent.articleId, a.id), eq(articleContent.language, "fr")))
    .limit(1)
)[0];

const comments = await db
  .select()
  .from(comment)
  .where(and(eq(comment.articleId, a.id), eq(comment.status, "published")))
  .orderBy(desc(comment.createdAt))
  .limit(20);

const user = Astro.locals.user;

type ContentBlock = { type: string; text?: string };
const contentBlocks: ContentBlock[] =
  content?.contentJson && Array.isArray(content.contentJson)
    ? (content.contentJson as ContentBlock[])
    : [];
---

<BaseLayout title={content?.title ?? slug} description={content?.summary ?? ""}>
  <main class="article-detail">
    <header class="article-header">
      <a href={getRelativeLocaleUrl(locale, "/articles")} class="back-link">‚Üê {t.common.back}</a>
      {a.coverImageUrl && (
        <img src={a.coverImageUrl} alt="" class="article-cover" />
      )}
      <h1>{content?.title ?? slug}</h1>
      {content?.summary && <p class="article-summary">{content.summary}</p>}
      {a.publishedAt && (
        <time class="article-date" datetime={a.publishedAt.toISOString()}>
          {t.magazine.publishedOn} {a.publishedAt.toLocaleDateString(locale)}
        </time>
      )}
    </header>

    <div class="article-body">
      {contentBlocks.length > 0 && (
        <div class="article-content">
          {contentBlocks.map((block) =>
            block.type === "heading" && block.text ? <h2>{block.text}</h2>
            : block.type === "paragraph" && block.text ? <p>{block.text}</p>
            : <Fragment />
          )}
        </div>
      )}
    </div>

    <section class="article-comments" aria-label={t.magazine.comments}>
      <h2>{t.magazine.comments} ({comments.length})</h2>
      {comments.length === 0 ? (
        <p class="no-comments">Aucun commentaire pour le moment.</p>
      ) : (
        <ul class="comment-list" role="list">
          {comments.map((c) => (
            <li class="comment-item">
              <p class="comment-content">{c.content}</p>
              <time class="comment-date" datetime={c.createdAt.toISOString()}>
                {c.createdAt.toLocaleDateString(locale)}
              </time>
            </li>
          ))}
        </ul>
      )}

      {user && (
        <a href="#comment-form" class="write-comment-link">
          {t.magazine.writeComment}
        </a>
      )}
    </section>
  </main>
</BaseLayout>

<style>
  .article-detail {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--space-6, 1.5rem) var(--space-4, 1rem);
  }

  .back-link {
    color: var(--color-primary, #3b82f6);
    text-decoration: none;
    font-size: var(--text-sm, 0.875rem);
    font-weight: 500;
    display: inline-block;
    margin-bottom: var(--space-4, 1rem);
  }

  .article-cover {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: var(--radius-lg, 0.5rem);
    margin-bottom: var(--space-4, 1rem);
  }

  .article-header h1 {
    font-size: var(--text-3xl, 1.875rem);
    font-weight: 800;
    margin: 0 0 var(--space-2, 0.5rem);
  }

  .article-summary {
    font-size: var(--text-lg, 1.125rem);
    color: var(--text-secondary, #64748b);
    line-height: 1.6;
    margin: 0 0 var(--space-2, 0.5rem);
  }

  .article-date {
    font-size: var(--text-sm, 0.875rem);
    color: var(--text-muted, #94a3b8);
  }

  .article-body {
    margin-top: var(--space-6, 1.5rem);
    line-height: 1.8;
    font-size: var(--text-base, 1rem);
  }

  .article-body h2 {
    font-size: var(--text-xl, 1.25rem);
    font-weight: 700;
    margin: var(--space-6, 1.5rem) 0 var(--space-3, 0.75rem);
  }

  .article-body p {
    margin: 0 0 var(--space-4, 1rem);
  }

  .article-comments {
    margin-top: var(--space-8, 2rem);
    border-top: 1px solid var(--border-color, #e2e8f0);
    padding-top: var(--space-6, 1.5rem);
  }

  .article-comments h2 {
    font-size: var(--text-xl, 1.25rem);
    font-weight: 700;
    margin: 0 0 var(--space-4, 1rem);
  }

  .comment-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3, 0.75rem);
  }

  .comment-item {
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-md, 0.375rem);
    padding: var(--space-3, 0.75rem);
  }

  .comment-content {
    margin: 0 0 var(--space-1, 0.25rem);
    font-size: var(--text-sm, 0.875rem);
    line-height: 1.5;
  }

  .comment-date {
    font-size: var(--text-xs, 0.75rem);
    color: var(--text-muted, #94a3b8);
  }

  .no-comments {
    color: var(--text-secondary, #64748b);
    font-style: italic;
  }

  .write-comment-link {
    display: inline-block;
    margin-top: var(--space-4, 1rem);
    padding: var(--space-2, 0.5rem) var(--space-4, 1rem);
    background: var(--color-primary, #3b82f6);
    color: #fff;
    border-radius: var(--radius-md, 0.375rem);
    text-decoration: none;
    font-weight: 600;
    font-size: var(--text-sm, 0.875rem);
  }
</style>
