---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { event, eventRegistration } from "@database/schemas";
import { eq, and, sql } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const { slug } = Astro.params;

if (!slug) return Astro.redirect(getRelativeLocaleUrl(locale, "/evenements"));

const eventRows = await db
  .select()
  .from(event)
  .where(eq(event.slug, slug))
  .limit(1);

if (eventRows.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/evenements"));

const e = eventRows[0];

const registrationCount = await db
  .select({ count: sql<number>`count(*)::int` })
  .from(eventRegistration)
  .where(and(eq(eventRegistration.eventId, e.id), eq(eventRegistration.status, "registered")));

const participantCount = registrationCount[0].count;
const isFull = e.maxParticipants !== null && participantCount >= e.maxParticipants;

const user = Astro.locals.user;
let isRegistered = false;
if (user) {
  const reg = await db
    .select()
    .from(eventRegistration)
    .where(and(eq(eventRegistration.eventId, e.id), eq(eventRegistration.userId, user.id)))
    .limit(1);
  isRegistered = reg.length > 0;
}
---

<BaseLayout title={e.title} description={e.description ?? ""}>
  <main class="event-detail">
    <header class="event-header">
      <a href={getRelativeLocaleUrl(locale, "/evenements")} class="back-link">← {t.common.back}</a>
      {e.type && <span class="event-type">{e.type}</span>}
      <h1>{e.title}</h1>

      <div class="event-key-info">
        <div class="info-item">
          <strong>{t.eventsPage.date}:</strong>
          <time datetime={e.startAt.toISOString()}>
            {e.startAt.toLocaleDateString(locale, { weekday: "long", day: "numeric", month: "long", year: "numeric", hour: "2-digit", minute: "2-digit" })}
          </time>
          {e.endAt && (
            <span>
              — <time datetime={e.endAt.toISOString()}>
                {e.endAt.toLocaleDateString(locale, { hour: "2-digit", minute: "2-digit" })}
              </time>
            </span>
          )}
        </div>

        <div class="info-item">
          <strong>Tarif:</strong>
          <span>{e.isPaid ? `${Number(e.price ?? 0).toFixed(2)} €` : t.eventsPage.free}</span>
        </div>

        {e.maxParticipants && (
          <div class="info-item">
            <strong>{t.eventsPage.participants}:</strong>
            <span>{participantCount} / {e.maxParticipants}</span>
            {isFull && <span class="badge-full">{t.eventsPage.full}</span>}
          </div>
        )}

        {e.registrationDeadline && (
          <div class="info-item">
            <strong>Date limite d'inscription:</strong>
            <time datetime={e.registrationDeadline.toISOString()}>
              {e.registrationDeadline.toLocaleDateString(locale)}
            </time>
          </div>
        )}
      </div>
    </header>

    {e.description && (
      <section class="event-body">
        <p>{e.description}</p>
      </section>
    )}

    <section class="event-actions">
      {user ? (
        isRegistered ? (
          <span class="registered-badge">{t.eventsPage.registered}</span>
        ) : isFull ? (
          <span class="full-badge">{t.eventsPage.full}</span>
        ) : (
          <a href={`/api/events/${e.slug}?action=register`} class="register-button">
            {t.eventsPage.register}
          </a>
        )
      ) : (
        <a href={getRelativeLocaleUrl(locale, "/auth/connexion")} class="register-button">
          {t.auth.signIn} — {t.eventsPage.register}
        </a>
      )}
    </section>
  </main>
</BaseLayout>

<style>
  .event-detail {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--space-6, 1.5rem) var(--space-4, 1rem);
  }

  .back-link {
    color: var(--color-primary, #3b82f6);
    text-decoration: none;
    font-size: var(--text-sm, 0.875rem);
    font-weight: 500;
    display: inline-block;
    margin-bottom: var(--space-4, 1rem);
  }

  .event-type {
    display: inline-block;
    font-size: var(--text-xs, 0.75rem);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted, #94a3b8);
    background: var(--bg-secondary, #f1f5f9);
    padding: var(--space-1, 0.25rem) var(--space-2, 0.5rem);
    border-radius: var(--radius-sm, 0.25rem);
    margin-bottom: var(--space-2, 0.5rem);
  }

  .event-header h1 {
    font-size: var(--text-3xl, 1.875rem);
    font-weight: 800;
    margin: 0 0 var(--space-4, 1rem);
  }

  .event-key-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-2, 0.5rem);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-lg, 0.5rem);
    padding: var(--space-4, 1rem);
    background: var(--bg-secondary, #f8f9fa);
  }

  .info-item {
    display: flex;
    gap: var(--space-2, 0.5rem);
    align-items: center;
    font-size: var(--text-sm, 0.875rem);
  }

  .badge-full {
    font-size: var(--text-xs, 0.75rem);
    background: var(--color-error, #ef4444);
    color: #fff;
    padding: 2px var(--space-2, 0.5rem);
    border-radius: var(--radius-sm, 0.25rem);
    font-weight: 600;
  }

  .event-body {
    margin-top: var(--space-6, 1.5rem);
    line-height: 1.8;
  }

  .event-body p {
    margin: 0;
    white-space: pre-line;
  }

  .event-actions {
    margin-top: var(--space-6, 1.5rem);
    padding-top: var(--space-4, 1rem);
    border-top: 1px solid var(--border-color, #e2e8f0);
  }

  .register-button {
    display: inline-block;
    padding: var(--space-3, 0.75rem) var(--space-6, 1.5rem);
    background: var(--color-primary, #3b82f6);
    color: #fff;
    border-radius: var(--radius-md, 0.375rem);
    text-decoration: none;
    font-weight: 700;
    font-size: var(--text-base, 1rem);
  }

  .registered-badge {
    display: inline-block;
    padding: var(--space-2, 0.5rem) var(--space-4, 1rem);
    background: var(--color-accent, #10b981);
    color: #fff;
    border-radius: var(--radius-md, 0.375rem);
    font-weight: 600;
  }

  .full-badge {
    display: inline-block;
    padding: var(--space-2, 0.5rem) var(--space-4, 1rem);
    background: var(--color-error, #ef4444);
    color: #fff;
    border-radius: var(--radius-md, 0.375rem);
    font-weight: 600;
  }
</style>
