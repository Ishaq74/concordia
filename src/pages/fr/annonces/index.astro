---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { classified, category } from "@database/schemas";
import { eq, and, sql, desc } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();

const url = new URL(Astro.request.url);
const search = url.searchParams.get("q") ?? "";
const categorySlug = url.searchParams.get("category") ?? "";
const conditionFilter = url.searchParams.get("condition") ?? "";
const page = Math.max(1, parseInt(url.searchParams.get("page") ?? "1", 10));
const limit = 12;
const offset = (page - 1) * limit;

const conditions: ReturnType<typeof eq>[] = [eq(classified.status, "active")];
if (search) {
  conditions.push(
    sql`(${classified.title} ILIKE ${"%" + search + "%"} OR ${classified.description} ILIKE ${"%" + search + "%"})`,
  );
}
if (categorySlug) {
  conditions.push(
    sql`${classified.categoryId} IN (SELECT id FROM category WHERE slug = ${categorySlug})`,
  );
}
if (conditionFilter) {
  conditions.push(eq(classified.condition, conditionFilter as "new" | "used" | "damaged"));
}

const where = and(...conditions);

const [ads, countResult] = await Promise.all([
  db
    .select({
      id: classified.id,
      title: classified.title,
      description: classified.description,
      price: classified.price,
      condition: classified.condition,
      location: classified.location,
      createdAt: classified.createdAt,
    })
    .from(classified)
    .where(where)
    .orderBy(desc(classified.createdAt))
    .limit(limit)
    .offset(offset),
  db
    .select({ count: sql<number>`count(*)::int` })
    .from(classified)
    .where(where),
]);

const total = countResult[0].count;
const totalPages = Math.ceil(total / limit);

const categories = await db
  .select({
    slug: category.slug,
    name: sql<string>`(SELECT ct.name FROM category_translation ct WHERE ct.category_id = ${category.id} AND ct.lang = ${locale} LIMIT 1)`,
  })
  .from(category)
  .where(and(eq(category.type, "classified"), eq(category.isActive, true)));

const conditionLabels: Record<string, string> = {
  new: t.classifiedsPage.conditionNew,
  used: t.classifiedsPage.conditionUsed,
  damaged: t.classifiedsPage.conditionDamaged,
};
---


<BaseLayout title={t.classifiedsPage.title} description={t.classifiedsPage.description}>
  <main class="classifieds-page">
    <header class="page-header">
      <h1>{t.classifiedsPage.title}</h1>
      <p>{t.classifiedsPage.description}</p>
      <a href={getRelativeLocaleUrl(locale, "/annonces/nouvelle")}
         class="cta-btn">
        <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#facc15"/><path d="M10 5v10M5 10h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
        Déposer une annonce
      </a>
    </header>
    <div class="classifieds-layout">
      <aside class="sidebar" aria-label="Filtres">
        <form method="get" action="" class="search-form" role="search">
          <input
            type="search"
            name="q"
            value={search}
            placeholder="Rechercher une annonce..."
            aria-label="Rechercher une annonce"
            class="search-input"
          />
          <select name="category" aria-label="Catégorie" class="filter-select">
            <option value="">Catégorie</option>
            {categories.map((cat) => (
              <option value={cat.slug} selected={cat.slug === categorySlug}>{cat.name}</option>
            ))}
          </select>
          <select name="condition" aria-label={t.classifiedsPage.condition} class="filter-select">
            <option value="">{t.classifiedsPage.condition}</option>
            <option value="new" selected={conditionFilter === "new"}>{t.classifiedsPage.conditionNew}</option>
            <option value="used" selected={conditionFilter === "used"}>{t.classifiedsPage.conditionUsed}</option>
            <option value="damaged" selected={conditionFilter === "damaged"}>{t.classifiedsPage.conditionDamaged}</option>
          </select>
          <button type="submit" class="search-button">{t.common.search}</button>
        </form>
        <div class="sidebar-actions">
          <a href={getRelativeLocaleUrl(locale, "/annonces/nouvelle")} class="sidebar-cta">
            <svg width="18" height="18" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#facc15"/><path d="M10 5v10M5 10h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
            Déposer une annonce
          </a>
        </div>
      </aside>
      <section class="classifieds-grid" aria-label={t.classifiedsPage.title}>
        {ads.length === 0 ? (
          <div class="empty-state">
            <div class="empty-illustration">
              <svg width="80" height="80" fill="none" viewBox="0 0 80 80"><rect width="80" height="80" rx="16" fill="#f1f5f9"/><path d="M20 60V30a10 10 0 0 1 10-10h20a10 10 0 0 1 10 10v30" stroke="#94a3b8" stroke-width="2"/><rect x="28" y="40" width="24" height="12" rx="3" fill="#facc15"/><rect x="34" y="44" width="12" height="4" rx="2" fill="#fff"/></svg>
            </div>
            <p class="empty-title">Aucune annonce pour le moment</p>
            <a href={getRelativeLocaleUrl(locale, "/annonces/nouvelle")} class="cta-btn">Déposer la première annonce</a>
          </div>
        ) : (
          <ul class="ad-list" role="list">
            {ads.map((ad) => (
              <li class="ad-card">
                <a href={getRelativeLocaleUrl(locale, `/annonces/${ad.id}`)} class="ad-link">
                  <div class="ad-card-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><rect width="32" height="32" rx="8" fill="#facc15"/><path d="M10 22V12a6 6 0 0 1 6-6h0a6 6 0 0 1 6 6v10" stroke="#fff" stroke-width="2"/></svg>
                  </div>
                  <div class="ad-card-body">
                    <h2 class="ad-title">{ad.title}</h2>
                    <p class="ad-description">{ad.description}</p>
                    <div class="ad-meta">
                      {ad.price && <span class="ad-price">{Number(ad.price).toFixed(2)} €</span>}
                      {ad.condition && (
                        <span class="ad-condition">{conditionLabels[ad.condition] ?? ad.condition}</span>
                      )}
                      {ad.location && <span class="ad-location">{ad.location}</span>}
                    </div>
                    <time class="ad-date" datetime={ad.createdAt.toISOString()}>
                      {ad.createdAt.toLocaleDateString(locale)}
                    </time>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        )}
        {totalPages > 1 && (
          <nav class="pagination" aria-label="Pagination">
            {page > 1 && (
              <a href={`?q=${search}&category=${categorySlug}&condition=${conditionFilter}&page=${page - 1}`} class="pagination-link" rel="prev">
                {t.common.previous}
              </a>
            )}
            <span class="pagination-info">Page {page} / {totalPages}</span>
            {page < totalPages && (
              <a href={`?q=${search}&category=${categorySlug}&condition=${conditionFilter}&page=${page + 1}`} class="pagination-link" rel="next">
                {t.common.next}
              </a>
            )}
          </nav>
        )}
      </section>
    </div>
  </main>
</BaseLayout>

<style>
  .classifieds-page { max-width: 1200px; margin: 0 auto; padding: var(--space-6, 1.5rem) var(--space-4, 1rem); }
  .page-header { text-align: center; margin-bottom: var(--space-6, 1.5rem); position: relative; }
  .page-header h1 { font-size: var(--text-3xl, 1.875rem); font-weight: 800; margin: 0 0 var(--space-2, 0.5rem); }
  .page-header p { color: var(--text-secondary, #64748b); font-size: var(--text-lg, 1.125rem); margin: 0; }
  .cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    background: #facc15;
    color: #222;
    font-weight: 700;
    border-radius: 0.5em;
    padding: 0.75em 1.5em;
    font-size: 1.1em;
    margin-top: 1.5em;
    text-decoration: none;
    box-shadow: 0 2px 8px #0001;
    transition: background 0.15s;
  }
  .cta-btn:hover { background: #ffe066; }

  .classifieds-layout {
    display: flex;
    gap: 2.5rem;
    align-items: flex-start;
  }
  .sidebar {
    flex: 0 0 270px;
    background: #f8fafc;
    border-radius: 1em;
    box-shadow: 0 2px 8px #0001;
    padding: 2em 1.5em 1.5em 1.5em;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    gap: 2em;
  }
  .search-form { display: flex; flex-direction: column; gap: 1em; }
  .search-input, .filter-select {
    width: 100%;
    padding: 0.7em 1em;
    border: 1px solid #e2e8f0;
    border-radius: 0.4em;
    font-size: 1em;
    background: #fff;
  }
  .search-button {
    background: #facc15;
    color: #222;
    border: none;
    border-radius: 0.4em;
    padding: 0.7em 1em;
    font-weight: 700;
    cursor: pointer;
    margin-top: 0.5em;
    transition: background 0.15s;
  }
  .search-button:hover { background: #ffe066; }
  .sidebar-actions { margin-top: 2em; }
  .sidebar-cta {
    display: flex;
    align-items: center;
    gap: 0.5em;
    background: #facc15;
    color: #222;
    font-weight: 700;
    border-radius: 0.5em;
    padding: 0.7em 1em;
    text-decoration: none;
    box-shadow: 0 2px 8px #0001;
    transition: background 0.15s;
  }
  .sidebar-cta:hover { background: #ffe066; }

  .classifieds-grid {
    flex: 1 1 0%;
    min-width: 0;
  }
  .ad-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5em;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .ad-card {
    border: 1px solid #e2e8f0;
    border-radius: 1em;
    overflow: hidden;
    background: #fffbe8;
    box-shadow: 0 2px 8px #0001;
    transition: box-shadow 0.2s;
    display: flex;
    align-items: flex-start;
    gap: 0.5em;
  }
  .ad-card:hover { box-shadow: 0 4px 16px #facc1533; }
  .ad-link { text-decoration: none; color: inherit; display: flex; align-items: flex-start; gap: 0.5em; width: 100%; }
  .ad-card-icon { flex: 0 0 48px; display: flex; align-items: center; justify-content: center; margin-top: 1em; }
  .ad-card-body { padding: 1.2em 1em 1em 0; flex: 1 1 0%; }
  .ad-title { font-size: 1.1em; font-weight: 700; margin: 0 0 0.3em 0; }
  .ad-description { font-size: 0.98em; color: #64748b; margin: 0 0 0.7em 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .ad-meta { display: flex; flex-wrap: wrap; gap: 0.7em; font-size: 0.95em; margin-bottom: 0.5em; }
  .ad-price { font-weight: 700; color: #eab308; font-size: 1.1em; }
  .ad-condition { background: #f1f5f9; padding: 2px 0.7em; border-radius: 0.3em; color: #64748b; }
  .ad-location { color: #94a3b8; }
  .ad-date { font-size: 0.95em; color: #94a3b8; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3em 0;
    color: #64748b;
    background: #f8fafc;
    border-radius: 1em;
    box-shadow: 0 2px 8px #0001;
    margin-top: 2em;
  }
  .empty-illustration { margin-bottom: 1.5em; }
  .empty-title { font-size: 1.2em; font-weight: 600; margin-bottom: 1em; }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5em;
    margin-top: 2em;
    padding: 1em 0;
  }
  .pagination-link {
    padding: 0.5em 1.2em;
    border: 1px solid #e2e8f0;
    border-radius: 0.4em;
    text-decoration: none;
    color: #facc15;
    font-weight: 500;
    background: #fffbe8;
    transition: background 0.15s;
  }
  .pagination-link:hover { background: #facc15; color: #222; }
  .pagination-info { color: #64748b; font-size: 1em; }

  @media (max-width: 900px) {
    .classifieds-layout { flex-direction: column; gap: 2em; }
    .sidebar { width: 100%; min-height: unset; }
    .classifieds-grid { width: 100%; }
  }
</style>
