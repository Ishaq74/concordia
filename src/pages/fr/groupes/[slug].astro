---
export const prerender = false;

import BaseLayout from "@layouts/BaseLayout.astro";
import { getDrizzle } from "@database/drizzle";
import { group, groupMember } from "@database/schemas";
import { eq, and, sql } from "drizzle-orm";
import translations from "@i18n/fr.json";
import { getRelativeLocaleUrl } from "@lib/i18n/locale-url";

const t = translations;
const locale = "fr";
const db = await getDrizzle();
const { slug } = Astro.params;

if (!slug) return Astro.redirect(getRelativeLocaleUrl(locale, "/groupes"));

const groupRows = await db
  .select()
  .from(group)
  .where(eq(group.slug, slug))
  .limit(1);

if (groupRows.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/groupes"));

const g = groupRows[0];

if (!g.isPublic) {
  const user = Astro.locals.user;
  if (!user) return Astro.redirect(getRelativeLocaleUrl(locale, "/auth/connexion"));
  const membership = await db
    .select()
    .from(groupMember)
    .where(and(eq(groupMember.groupId, g.id), eq(groupMember.userId, user.id)))
    .limit(1);
  if (membership.length === 0) return Astro.redirect(getRelativeLocaleUrl(locale, "/groupes"));
}

const memberCount = await db
  .select({ count: sql<number>`count(*)::int` })
  .from(groupMember)
  .where(eq(groupMember.groupId, g.id));

const user = Astro.locals.user;
let isMember = false;
let memberRole = "";
if (user) {
  const mem = await db
    .select()
    .from(groupMember)
    .where(and(eq(groupMember.groupId, g.id), eq(groupMember.userId, user.id)))
    .limit(1);
  isMember = mem.length > 0;
  memberRole = mem[0]?.role ?? "";
}

const isCreator = user?.id === g.createdBy;
---

<BaseLayout title={g.name} description={g.description ?? ""}>
  <main class="group-detail">
    <header class="group-header">
      <a href={getRelativeLocaleUrl(locale, "/groupes")} class="back-link">← {t.common.back}</a>
      <h1>{g.name}</h1>
      {g.description && <p class="group-description">{g.description}</p>}
      <div class="group-stats">
        <span>{memberCount[0].count} membres</span>
        <span>{g.isPublic ? "Public" : "Privé"}</span>
      </div>
    </header>

    <section class="group-actions">
      {user && !isMember && g.isPublic && (
        <a href={`/api/groups/${g.slug}?action=join`} class="join-button">Rejoindre le groupe</a>
      )}
      {isMember && (
        <span class="member-badge">Membre ({memberRole})</span>
      )}
      {isCreator && (
        <a href={getRelativeLocaleUrl(locale, `/groupes/${g.slug}/gestion`)} class="manage-link">Gérer le groupe</a>
      )}
    </section>
  </main>
</BaseLayout>

<style>
  .group-detail { max-width: 800px; margin: 0 auto; padding: var(--space-6, 1.5rem) var(--space-4, 1rem); }
  .back-link { color: var(--color-primary, #3b82f6); text-decoration: none; font-size: var(--text-sm, 0.875rem); font-weight: 500; display: inline-block; margin-bottom: var(--space-4, 1rem); }
  .group-header h1 { font-size: var(--text-3xl, 1.875rem); font-weight: 800; margin: 0 0 var(--space-2, 0.5rem); }
  .group-description { font-size: var(--text-lg, 1.125rem); color: var(--text-secondary, #64748b); line-height: 1.6; margin: 0 0 var(--space-4, 1rem); white-space: pre-line; }
  .group-stats { display: flex; gap: var(--space-3, 0.75rem); font-size: var(--text-sm, 0.875rem); color: var(--text-muted, #94a3b8); }
  .group-actions { margin-top: var(--space-6, 1.5rem); display: flex; gap: var(--space-3, 0.75rem); align-items: center; flex-wrap: wrap; }
  .join-button { display: inline-block; padding: var(--space-2, 0.5rem) var(--space-4, 1rem); background: var(--color-primary, #3b82f6); color: #fff; border-radius: var(--radius-md, 0.375rem); text-decoration: none; font-weight: 600; }
  .member-badge { padding: var(--space-2, 0.5rem) var(--space-4, 1rem); background: var(--color-accent, #10b981); color: #fff; border-radius: var(--radius-md, 0.375rem); font-weight: 600; }
  .manage-link { color: var(--color-primary, #3b82f6); text-decoration: none; font-weight: 500; font-size: var(--text-sm, 0.875rem); }
</style>
